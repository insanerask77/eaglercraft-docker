# Default values for eaglercraft Helm chart

# Global Configuration
global:
  # Image registry configuration
  imageRegistry: registry.easypanel.madolell.com

  # Image pull secrets for private registry
  # Create the secret with:
  # kubectl create secret docker-registry docker-registry \
  #   --docker-server=registry.easypanel.madolell.com \
  #   --docker-username=<your-username> \
  #   --docker-password=<your-password> \
  #   --docker-email=<your-email>
  imagePullSecrets:
    - name: docker-registry

# Nginx Proxy Configuration
nginxProxy:
  image:
    repository: nginx
    tag: alpine
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    type: ClusterIP
    port: 80
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Landing Page Configuration
landingPage:
  image:
    repository: registry.easypanel.madolell.com/eaglercraft/landing-page
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    port: 80
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Eaglercraft Game Server Configuration
eaglercraft:
  image:
    repository: registry.easypanel.madolell.com/eaglercraft/server
    tag: latest
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    port1: 5200
    port2: 5201
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi
  persistence:
    enabled: true
    storageClass: "local-path"
    accessMode: ReadWriteOnce
    size: 10Gi
    # If you want to use existing PVCs, specify them here
    existingClaim: ""

# Nginx Configuration
nginx:
  config: |-
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Performance
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

        # Use Kubernetes DNS resolver for dynamic service discovery
        resolver kube-dns.kube-system.svc valid=10s;
        resolver_timeout 5s;

        # WebSocket connection upgrade mapping
        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {
            listen 80;
            server_name _;

            # Landing page - root path
            location / {
                set $landing_page {{ include "eaglercraft.landingPage.fullname" . }}.{{ .Release.Namespace }}.svc;
                proxy_pass http://$landing_page:80;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Game - direct access with WebSocket support
            location /game/ {
                set $eaglercraft_game {{ include "eaglercraft.eaglercraft.fullname" . }}.{{ .Release.Namespace }}.svc;
                proxy_pass http://$eaglercraft_game:5200/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # WebSocket support - CRITICAL for Eaglercraft
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                
                # Timeouts for WebSocket
                proxy_connect_timeout 7d;
                proxy_send_timeout 7d;
                proxy_read_timeout 7d;
                
                # Buffering
                proxy_buffering off;
            }
        }
    }
